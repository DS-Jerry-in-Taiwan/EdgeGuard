name: EdgeGuard Production Auto-Deploy

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Phase 3 PASS, trigger production deploy'
        required: false
  workflow_run:
    workflows: ["EdgeGuard ML Quantization & Performance Gate"]
    types:
      - completed
    branches:
      - main
  push:
    branches:
      - main

jobs:
  deploy-prod:
    runs-on: [self-hosted, gpu]
    steps:
      - name: Check quantize workflow status
        run: |
          status=$(gh run list --workflow="EdgeGuard ML Quantization & Performance Gate" --branch=main --limit=1 --json conclusion -q '.[0].conclusion')
          if [ "$status" != "success" ]; then
            echo "Quantize workflow not successful, skipping deploy."
            exit 1
          fi
      - name: Fix models/output permissions
        run: sudo chown -R $USER:$USER models/output || true && sudo chmod -R 777 models/output || true

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Stop old service
        run: docker-compose -f docker-compose.prod.yml down

      - name: Deploy new version
        run: docker-compose -f docker-compose.prod.yml up -d

      - name: Health check (60s)
        run: python3 scripts/health_check.py

      - name: Notify success
        if: success()
        run: python3 scripts/slack_notifier.py --level info --message "Production deploy succeeded"

      - name: Rollback on failure
        if: failure()
        run: bash scripts/rollback.sh

      - name: Notify failure
        if: failure()
        run: python3 scripts/slack_notifier.py --level critical --message "Production deploy failed, rollback triggered"
