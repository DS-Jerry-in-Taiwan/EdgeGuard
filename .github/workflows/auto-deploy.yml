name: EdgeGuard Production Auto-Deploy

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Phase 3 PASS, trigger production deploy'
        required: false
  workflow_run:
    workflows: ["EdgeGuard ML Quantization & Performance Gate"]
    types:
      - completed
    branches:
      - main
  push:
    branches:
      - main

jobs:
  deploy-prod:
    runs-on: [self-hosted, gpu]
    steps:
      - name: Check quantize workflow status
        uses: actions/github-script@v6
        with:
          script: |
            const run_id = process.env.GITHUB_RUN_ID;
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "mlops.yaml",
              branch: "main",
              status: "completed"
            });
            if (!runs.workflow_runs.length || runs.workflow_runs[0].conclusion !== "success") {
              core.info("Quantize workflow not successful, skipping deploy.");
              process.exit(0);
            }

      - name: Fix models/output permissions
        run: sudo chown -R $USER:$USER models/output || true && sudo chmod -R 777 models/output || true

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Stop old service
        run: docker-compose -f docker-compose.prod.yml down

      - name: Deploy new version
        run: docker-compose -f docker-compose.prod.yml up -d

      - name: Health check (60s)
        run: python3 scripts/health_check.py

      - name: Notify success
        if: success()
        run: python3 scripts/slack_notifier.py --level info --message "Production deploy succeeded"

      - name: Rollback on failure
        if: failure()
        run: bash scripts/rollback.sh

      - name: Notify failure
        if: failure()
        run: python3 scripts/slack_notifier.py --level critical --message "Production deploy failed, rollback triggered"
